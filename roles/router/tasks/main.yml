---
# Main tasks file for router role

- name: Initialize vpn_servers
  ansible.builtin.set_fact:
    vpn_servers: []
  when: vpn_servers is not defined or vpn_servers | length == 0
  tags: [always]

- name: Build vpn_servers from vault
  ansible.builtin.set_fact:
    vpn_servers: >-
      {{ vpn_servers + [{
        'name': item.name,
        'server_ipv4': item.server_ipv4,
        'server_ipv6': item.server_ipv6 | default(''),
        'public_key': item.public_key,
        'short_id': item.short_id,
        'uuid': item.clients[vpn_client_name]
      }] }}
  loop: "{{ vault_vpn_servers }}"
  loop_control:
    label: "{{ item.name }}"
  when: vpn_servers | length < vault_vpn_servers | length
  tags: [always]

- name: Import packages installation tasks
  ansible.builtin.import_tasks: packages.yml
  tags: [packages]

- name: Import network configuration tasks
  ansible.builtin.import_tasks: network.yml
  tags: [network]

- name: Import sysctl performance tuning tasks
  ansible.builtin.import_tasks: sysctl.yml
  tags: [sysctl, performance]

- name: Import domains configuration tasks
  ansible.builtin.import_tasks: domains.yml
  tags: [domains]

- name: Import PAC file generation tasks
  ansible.builtin.import_tasks: pac.yml
  tags: [pac]

- name: Import sing-box configuration tasks
  ansible.builtin.import_tasks: singbox.yml
  tags: [singbox]

- name: Import WiFi configuration tasks
  ansible.builtin.import_tasks: wifi.yml
  tags: [wifi]

- name: Import cleanup tasks
  ansible.builtin.import_tasks: cleanup.yml
  tags: [cleanup]
